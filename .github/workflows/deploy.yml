name: Deploy Backend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Configurar Git para usar SSH
          echo "ğŸ”§ Configuring Git..."
          cd /var/www/ecommerce-backend
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin git@github.com:fabriconiglio/importcba-backend.git
          
          # Copiar el script de despliegue si no existe
          if [ ! -f deploy-script.sh ]; then
            echo "ğŸ“ Creating deployment script..."
            cat > deploy-script.sh << 'EOF'
          #!/bin/bash
          
          # Script de despliegue para el backend
          set -e
          
          echo "ğŸš€ Starting deployment..."
          
          # Variables
          PROJECT_DIR="/var/www/ecommerce-backend"
          BACKUP_DIR="/var/www/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Crear directorio de backups si no existe
          mkdir -p $BACKUP_DIR
          
          # Navegar al directorio del proyecto
          cd $PROJECT_DIR
          
          # Backup de la base de datos antes del despliegue
          echo "ğŸ’¾ Creating database backup..."
          sudo -u postgres pg_dump ecommerce_import > $BACKUP_DIR/backup_before_deploy_$TIMESTAMP.sql
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          git clean -fdx
          git checkout -- .
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          composer install --no-dev --optimize-autoloader
          
          # Clear caches
          echo "ğŸ§¹ Clearing caches..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear
          
          # Check if there are pending migrations
          echo "ğŸ” Checking for pending migrations..."
          MIGRATION_STATUS=$(php artisan migrate:status 2>/dev/null || echo "No migrations table")
          
          if echo "$MIGRATION_STATUS" | grep -q "No"; then
            echo "ğŸ”„ Running migrations..."
            php artisan migrate --force
          else
            echo "âœ… No pending migrations found"
          fi
          
          # Set permissions
          echo "ğŸ” Setting permissions..."
          chown -R www-data:www-data $PROJECT_DIR
          chmod -R 755 $PROJECT_DIR
          chmod -R 775 storage bootstrap/cache
          
          # Restart services
          echo "ğŸ”„ Restarting services..."
          systemctl restart php8.3-fpm
          systemctl reload nginx
          
          echo "âœ… Deployment completed successfully!"
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 5
          
          if curl -f http://localhost/api/v1/health > /dev/null 2>&1; then
            echo "âœ… Health check passed!"
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âŒ Health check failed!"
            echo "âš ï¸ Health check failed but deployment might still be working"
            echo "ğŸ” Checking if application responds..."
            if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "âœ… Application is responding, deployment successful!"
            else
              echo "âŒ Application not responding, but skipping rollback due to data conflicts"
              echo "ğŸ”§ Manual intervention may be required"
            fi
          fi
          
          # Limpiar backups antiguos
          ls -t $BACKUP_DIR/backup_before_deploy_*.sql | tail -n +6 | xargs -r rm
          
          echo "ğŸ¯ Deployment script completed!"
          EOF
          fi
          
          # Hacer el script ejecutable y ejecutarlo
          chmod +x deploy-script.sh
          ./deploy-script.sh 